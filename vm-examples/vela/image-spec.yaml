# Input to vm-builder
---
commands:
  - name: cgconfigparser
    user: root
    sysvInitAction: sysinit
    shell: '/usr/sbin/cgconfigparser -l /etc/cgconfig.conf -s 1664'
  - name: vm-monitor
    user: vm-monitor
    sysvInitAction: respawn
    shell: 'RUST_LOG=info /bin/vm-monitor --cgroup=vela --addr="0.0.0.0:10301"'
  - name: create-fifo
    user: root
    sysvInitAction: wait
    shell: 'mkfifo -m 0666 /tmp/neon-logs.fifo'
  - name: log-redirect
    user: root
    sysvInitAction: respawn
    shell: 'cat /tmp/neon-logs.fifo > /dev/virtio-ports/tech.neon.log.0'
  - name: postgres-exporter
    user: nobody
    sysvInitAction: respawn
    shell: 'DATA_SOURCE_NAME="user=cloud_admin sslmode=disable dbname=postgres" /bin/postgres_exporter'
  - name: secrets
    user: root
    sysvInitAction: once
    shell: '/usr/local/bin/secrets-to-env /vela/secrets >> /vela/env'
  - name: compose
    user: root
    sysvInitAction: once
    shell: 'cgexec -g memory:vela podman compose --file /vela/config/docker-compose.yml --env-file /vela/env up --detach'
files:
  - filename: cgconfig.conf
    hostPath: cgconfig.conf
  - filename: secrets-to-env
    hostPath: secrets-to-env
build: |
  ARG RUST_IMG_TAG=replaceme
  ARG RUST_IMG_SHA=replaceme
  ARG ALPINE_IMG_TAG=replaceme
  ARG ALPINE_IMG_SHA=replaceme

  # Build vm-monitor
  FROM rust:$RUST_IMG_TAG$RUST_IMG_SHA AS monitor-builder
  WORKDIR /workspace

  RUN apk add musl-dev git openssl-dev

  # Which branch to pull from
  ENV BRANCH main

  # Ensures we reclone upon new commits
  # https://stackoverflow.com/questions/35134713
  ADD "https://api.github.com/repos/neondatabase/neon/commits/$BRANCH" latest_commit

  RUN git clone --depth 1 --branch $BRANCH https://github.com/neondatabase/neon.git
  RUN cargo build --release --manifest-path neon/libs/vm_monitor/Cargo.toml
  # Move binary so we can cargo clean
  RUN mkdir -p /workspace/bin && cp /workspace/neon/target/release/vm-monitor /workspace/bin
  # Cargo clean dramatically reduces the size of the image
  RUN cargo clean --release --manifest-path neon/libs/vm_monitor/Cargo.toml

  FROM quay.io/prometheuscommunity/postgres-exporter:v0.12.0@sha256:f34d50a64a4d558ad118ffc73be45a359ac8f30b8daba4b241458bcb9f94e254 AS postgres-exporter

merge: |
  RUN adduser vm-monitor --disabled-password --no-create-home

  COPY cgconfig.conf         /etc/cgconfig.conf
  COPY secrets-to-env      /usr/local/bin/secrets-to-env
  RUN chmod +x /usr/local/bin/secrets-to-env

  # General tools
  RUN set -e \
      && apk add --no-cache \
              ca-certificates \
              util-linux-misc \
              coreutils \
              cgroup-tools

  # container handling
  RUN set -e && apk add --no-cache podman python3 py3-pip
  RUN set -e && pip3 install --break-system-packages --no-cache-dir podman-compose

  COPY --from=monitor-builder       /workspace/bin/vm-monitor /bin/vm-monitor
  COPY --from=postgres-exporter /bin/postgres_exporter /bin/postgres_exporter

  # set the greeting message on ssh logins
  RUN echo -e 'Welcome to Alpine!\n ~ This is the VM :) ~' >/etc/motd
