# Input to vm-builder
---
commands:
  - name: cgconfigparser
    user: root
    sysvInitAction: sysinit
    shell: '/usr/sbin/cgconfigparser -l /etc/cgconfig.conf -s 1664'
  # containerd + load-image REMOVED â€“ we don't use a daemon or ctr anymore
  - name: vm-monitor
    user: vm-monitor
    sysvInitAction: respawn
    shell: 'RUST_LOG=info /bin/vm-monitor --cgroup=neon-test --addr="0.0.0.0:10301"'
  - name: create-fifo
    user: root
    sysvInitAction: wait
    shell: 'mkfifo -m 0666 /tmp/neon-logs.fifo'
  - name: log-redirect
    user: root
    sysvInitAction: respawn
    shell: 'cat /tmp/neon-logs.fifo > /dev/virtio-ports/tech.neon.log.0'
  - name: run-postgres
    user: root
    sysvInitAction: respawn
    shell: '/usr/local/bin/run-postgres-runc.sh'

files:
  - filename: pg_hba.conf
    hostPath: pg_hba.conf
  - filename: allocate-loop.c
    hostPath: allocate-loop.c
  - filename: cgconfig.conf
    hostPath: cgconfig.conf

build: |
  ARG RUST_IMG_TAG=replaceme
  ARG RUST_IMG_SHA=replaceme
  ARG ALPINE_IMG_TAG=replaceme
  ARG ALPINE_IMG_SHA=replaceme

  # Build vm-monitor
  FROM rust:$RUST_IMG_TAG$RUST_IMG_SHA AS monitor-builder
  WORKDIR /workspace

  RUN apk add musl-dev git openssl-dev

  # Which branch to pull from
  ENV BRANCH main

  # Ensures we reclone upon new commits
  # https://stackoverflow.com/questions/35134713
  ADD "https://api.github.com/repos/neondatabase/neon/commits/$BRANCH" latest_commit

  RUN git clone --depth 1 --branch $BRANCH https://github.com/neondatabase/neon.git
  RUN cargo build --release --manifest-path neon/libs/vm_monitor/Cargo.toml
  # Move binary so we can cargo clean
  RUN mkdir -p /workspace/bin && cp /workspace/neon/target/release/vm-monitor /workspace/bin
  # Cargo clean dramatically reduces the size of the image
  RUN cargo clean --release --manifest-path neon/libs/vm_monitor/Cargo.toml

  # Build the allocation tester:
  FROM alpine:$ALPINE_IMG_TAG$ALPINE_IMG_SHA AS allocate-loop-builder
  RUN set -e \
      && apk add gcc musl-dev
  COPY allocate-loop.c allocate-loop.c
  RUN set -e \
      && gcc -g -O allocate-loop.c -o /bin/allocate-loop

merge: |
  ENV PGDATA=/var/lib/postgresql/data

  RUN adduser vm-monitor --disabled-password --no-create-home

  COPY cgconfig.conf         /etc/cgconfig.conf
  COPY pg_hba.conf           /etc/pg_hba.conf

  # General tools: no containerd; we use runc+umoci+skopo+jq
  RUN set -e \
      && apk add --no-cache \
              ca-certificates \
              util-linux-misc \
              coreutils \
              cgroup-tools \
              skopeo \
              runc \
              umoci \
              jq

  # Pre-fetch and unpack Supabase Postgres into an OCI bundle for runc
  RUN set -e \
      && mkdir -p /opt/postgres-oci /opt/postgres-bundle \
      && skopeo copy docker://docker.io/supabase/postgres:15.1.0.147 oci:/opt/postgres-oci:latest \
      && umoci unpack --image /opt/postgres-oci:latest /opt/postgres-bundle \
      && cd /opt/postgres-bundle \
      # Make config host-network and add host bind mounts
      && jq '
           .linux.namespaces |= map(select(.type != "network")) 
           | .mounts += [
               {
                 "destination": "/var/lib/postgresql/data",
                 "type": "bind",
                 "source": "/var/lib/postgresql/data",
                 "options": ["rbind","rw"]
               },
               {
                 "destination": "/etc/postgresql/pg_hba.conf",
                 "type": "bind",
                 "source": "/etc/pg_hba.conf",
                 "options": ["rbind","ro"]
               }
             ]
           | .process.env = []
         ' config.json > config.template.json \
      && rm config.json \
      && rm -rf /opt/postgres-oci

  # Simple wrapper to regenerate config.json with runtime env and run runc
  RUN cat >/usr/local/bin/run-postgres-runc.sh << 'EOF'
#!/bin/sh
set -e

# Load env / secrets if provided by the platform
if [ -f /neonvm/runtime/env.sh ]; then
  . /neonvm/runtime/env.sh
fi

: "${POSTGRES_PASSWORD:?POSTGRES_PASSWORD not set}"
: "${JWT_SECRET:=$POSTGRES_PASSWORD}"

cd /opt/postgres-bundle

# Generate config.json from template, injecting env vars
jq '
  .process.env = [
    "POSTGRES_PASSWORD=" + env.POSTGRES_PASSWORD,
    "JWT_SECRET=" + env.JWT_SECRET,
    "JWT_EXP=3600"
  ]
' config.template.json > config.json

exec runc run vela-db
EOF

  RUN chmod +x /usr/local/bin/run-postgres-runc.sh

  COPY --from=allocate-loop-builder /bin/allocate-loop        /bin/allocate-loop
  COPY --from=monitor-builder       /workspace/bin/vm-monitor /bin/vm-monitor

  # set the greeting message on ssh logins
  RUN echo -e 'Welcome to Alpine!\n ~ This is the VM :) ~' >/etc/motd
