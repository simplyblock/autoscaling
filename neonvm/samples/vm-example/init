#!/bin/sh

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# system mounts
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
mkdir -p /dev/shm
chmod 1777 /dev/shm
mount -t tmpfs tmp /dev/shm

# start udev (mostly used for auto-online hotplugged CPUs)
udevd --daemon

# networking
ip link set up dev lo
ETH_LIST=$(find /sys/class/net -mindepth 1 -maxdepth 1 -name "eth*")
for i in ${ETH_LIST}; do
    iface=$(basename $i)
    ip link set up dev $iface
    udhcpc -t 1 -T 1 -A 1 -b -q -i $iface -O 121 -O 119
done

# Prepare optional external data disk (virtio block device "data").
DATA_DEV="/dev/disk/by-id/virtio-data"
if [ ! -b "$DATA_DEV" ]; then
  DATA_DEV="/dev/vdb"
fi

if [ -b "$DATA_DEV" ]; then
  echo "Configuring external data volume on $DATA_DEV"
  mkdir -p /data
  if ! blkid "$DATA_DEV" >/dev/null 2>&1; then
    echo "Formatting $DATA_DEV as ext4"
    mkfs.ext4 -F "$DATA_DEV"
  fi
  if ! mount | grep -q " /data "; then
    mount "$DATA_DEV" /data
  fi
  chown postgres:postgres /data
  if [ ! -f /data/PG_VERSION ]; then
    echo "Initializing new Postgres data directory under /data"
    su-exec postgres initdb -D /data
  fi
  export PGDATA=/data
else
  echo "External data disk not found; using image root volume"
  export PGDATA=/var/lib/postgresql
fi

# postgresql init and start
su-exec postgres pg_ctl start -o '-c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf'

echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"

echo "Start getty for console"
while true; do
  setsid -w /sbin/agetty --8bits --local-line --noissue --noclear --noreset --login-pause --autologin root 115200 ttyS0
  sleep 1
done

echo "Exiting and shutting down vm"
su-exec postgres pg_ctl stop
poweroff -f
